# 1.域名设计 #

----------
###演化发展###
[13]

- 互联网时代计算机行业发展迅速，主机数量的爆炸性增长使网络数量、网络结构也在相应改变。
- 在ARPAnet采用TCP/IP协议后，网络用户激增。
- 原本的地址解析过程使用HOSTS.TXT主文件。此HOSTS文件由网络信息中心(Network Information Center, NIC)负责分发和定期维护， 所有主机通过文件传输协议(File Transfer Protocol,FTP)连接到NIC获得该文件。

- 随着主机数的增长，HOSTS主文件出现如下问题：
   1. 文件大小逐渐变大：网络中每出现一台新主机，HOSTS主文件就增加一行
   1. 传输时产生的网络流量逐渐增大
   1. 处理器负载变大
   1. 名称冲突：NIC在维护过程中无法保证网络中不出现同名主机，避免打乱整个机制
   1. 一致性难以维持：网络传播的时延可能导致在新的HOSTS主文件传播到全网之前已经有某台主机的地址发生变化



**最根本问题:**HOSTS.TXT机制的扩展性不好。


- 为了管理方便，需要新系统
###新系统的基本要求：###
[1]

- 允许在本地管理数据，同时又能使数据在世界范围内可用----一致性、名称冲突
- 分布式管理方式-------分散网络流量
- 采用层次结构的命名空间为主机命名------保证命名唯一性


![](http://i.imgur.com/LDcQOzC.gif)

#2.域名原理  

----------

###DNS的工作原理及过程：
[17]

1. 客户机提出域名解析请求,并将该请求发送给本地的域名服务器。
1. 当本地的域名服务器收到请求后,就先查询本地的缓存,如果有该纪录项,则本地的域名服务器就直接把查询的结果返回。
1. 如果本地的缓存中没有该纪录,则本地域名服务器就直接把请求发给根域名服务器,然后根域名服务器再返回给本地域名服务器一个所查询域(根的子域)的主域名服务器的地址。
1. 本地服务器再向上一步返回的域名服务器发送请求,然后接受请求的服务器查询自己的缓存,如果没有该纪录,则返回相关的下一个所查询域的域名服务器的地址。
1. 重复第四步,直到找到正确的纪录。
1. 本地域名服务器把返回的结果保存到缓存,以备下一次使用,同时还将结果返回给客户机。


![](http://i.imgur.com/JyfCAHi.jpg)[4]


![](http://i.imgur.com/66KYeVj.jpg)[7]


# 3.域名结构 #

----------

- 整个域名系统是一个联机分布式数据库。允许对数据库的各个部分进行本地控制。
- DNS有三个主要部分，各个部分的数据通过C/S模式使数据对全网可用。

  1. **名称服务器**(NAME SERVERS)，服务器程序，保存有关域树的结构的信息和设置信息。名称服务器可以缓存有关域树的任何部分的结构和设置信息，但是一般而言，特定的名称服务器具有关于该域空间的子集的完整信息，和指向其他名称服务器的指针，这些其他服务器可用于从域树的任何部分引导信息。名称服务器知道域树的各个部分(它们对其有完整信息)； 对于名称空间的这些部分， 名称服务器被看作是权威(AUTHORITY)。 权威信息被编排进称作区域(ZONEs)的单元，这些区域可以自动分配给为区域中的数据提供冗余服务的名称服务器。
  2. **解析器**(RESOLVERS)，客户端程序，是为了响应计算机请求从名称服务器提取信息的程序。解析器必须能够访问至少一个名称服务器，并使用那个名称服务器的信息直接回答查询，或使用到其他名称服务器的转介，继续查询。解析器一般是系统例行程序（库例程），它可直接访问到用户程序；因此在解析器和用户程序间不需要协议。
  3. **域名空间和资源记录**(DOMAIN NAME SPAC and RESOURCE RECORDS)， 树状结构名称空间和与这些名称关联的数据的规范。从概念上讲，每个节点和域名空间树的叶子命名一组信息，查询操作是从特定集合提取特定类型信息。查询命名感兴趣的域名和描述希望的资源信息类型。 例如，互联网使用它的某个域名标识主机；地址资源的查询返回互联网主机地址。


![](http://i.imgur.com/VA4eDVn.png) [10]

- 域名系统的整体结构为倒置树形结构，其结构由“文本标签”和“节点”组成，用来标识该节点和父节点的相对关系，不区分叶子节点和非叶子节点，每个节点对应一个实际标签，在标签的使用中规定：
   - 兄弟标签不能重名；
   - 标签区分大小写，但实际无意义；
   - 根节点是所有域名节点的开始节点，是一个空的标签，用“ ”或“.”表示。

![](http://i.imgur.com/HTuDsW1.jpg)[6]

- 每个节点都是其对应子树的根节点。每棵子树都代表一个域，每个域又可被划分为若干个子域。每个域的域名标识了它在数据库中的位置。每个子域都可以被划分给同一域名组织下的不同子级组织。


- DNS中，域名是指从该域的根节点开始，一直回溯到整棵树的根节点的标签序列，以“.”分隔路径中的各个节点标签。故域名的结构为：**主机名.三级域名.二级域名.顶级域名**

![5](http://i.imgur.com/F7BmJMl.jpg)[5]



# 4.相关概念 #
[3]

----------

###绝对域名（Fully Qualified Name）


- 又叫完全限定域名，是指含有根域名的完整域名，即域名最右端含有根域名“.”，比如“http://www.abc.cn.”


###域名分类
[16]

- 英文国际域名
- 英文国内域名
- 中文国际域名
- 中文通用域名（又称中文顶级域名）
- 中国国家域名
- 通用网址

###域名级别

- **顶级域名TLDs(top-level domainnames)**
   - 国家和地区顶级域名（country code top-level domains，简称ccTLDs），按照ISO3166国家代码给200多个国家都分配了两字符长度的顶级域名
   - 通用顶级域名（generic top-level domains，简称gTLDs），一般为组织、机构、群体等设立。     

         -  以机构区分的最高域名原来有7 个：
           - com（商业机构）、 
           - net（网络服务机构）、
           - gov（政府机构）、
           - mil（军事机构）、
           - org（非盈利性组织）、
           - edu（教育部门）、
           - int（国际机构）。
     - 1997 年又新增7个最高级标准域名：
          - firm（企业和公司）、
          - store（商业企业）、
          - web（从事与WEB 相关业务的实体）、
          - arts（从事文化娱乐的实体）、
          - REC（从事休闲娱乐业的实体）、
          - info（从事信息服务业的实体）、
          - nom（从事个人活动的个体、发布个人信息）。
          

![](http://i.imgur.com/iWV86GJ.png)



[国际顶级域名统计](https://newgtlds.icann.org/en/program-status/statistics )


- **二级域名**

   - 二级域名是指顶级域名之下的域名，在国际顶级域名下，它是指域名注册人的网上名称，例如 ibm，yahoo，microsoft等；在国家顶级域名下，它是表示注册企业类别的符号，例如com，edu，gov，net等。

- **三级域名**

   - 三级域名用字母（ A～Z，a～z，大小写等）、数字（0～9）和连接符（－）组成， 各级域名之间用实点（.）连接，三级域名的长度不能超过20个字符。 如无特殊原因，建议采用申请人的英文名（或者缩写）或者汉语拼音名 （或者缩写） 作为三级域名，以保持域名的清晰性和简洁性。


###A（Address）记录
[2]

- 用来指定主机名（或域名）对应的IP地址记录。用户可以将该域名下的网站服务器指向到自己的web server上。



###别名（CNAME）

- 从某个域名或别名指向另一个规范域名的指针
- DNS系统允许将多个别名映射到同一台计算机（服务器），实现在多个域名需要指向同一服务器IP时，进行服务的指定。通常用于同时提供WWW和MAIL服务的计算机。
    

   - 例如，有一台计算机名为“host.mydomain.com”（A记录）。 它同时提供WWW和MAIL服务，为了便于用户访问服务。可以为该计算机设置两个别名（CNAME）：WWW和MAIL。 这两个别名的全称就是“www.mydomain.com”和“mail.mydomain.com”。实际上他们都指向“host.mydomain.com”。 在DNS解析到此服务器上时，使用别名进入www服务或者mail服务。
- 同时，在服务器IP地址变更时，只需更改A记录域名，别名域名将自动更新到新的IP地址上，减少了工作量。


![](http://i.imgur.com/w32rInE.jpg)


###域名服务器分类
-  **主域名服务器（PRIMARY SERVERS）**
负责维护一个区域的所有域名信息的名称解析，是特定的所有信息的权威信息源，数据可以修改。通常只有一个
- **辅助域名服务器（SECONDARY SERVERS）**
域的冗余和备份。当主域名服务器出现故障、关闭或负载过重时，辅助域名服务器作为主域名服务器的备份提供域名解析服务。辅助域名服务器中的区域文件中的数据是从另外的一台主域名服务器中复制过来的，是不可以修改的。是
- **缓存域名服务器（CACHE-ONLY SERVERS）**
缓存非授权的DNS信息。从某个远程服务器取得每次域名服务器的查询回答，一旦取得一个答案就将它放在高速缓存中，以后查询相同的信息就用高速缓存中的数据回答，缓存域名服务器不是权威的域名服务器，因为它提供的信息都是间接信息。
- **转发域名服务器（FORWARDING SERVERS）**
负责所有非本地域名的本地查询。转发域名服务器接到查询请求后，在其缓存中查找，如找不到就将请求依次转发到指定的域名服务器，直到查找到结果为止，否则返回无法映射的结果。

- **根域名服务器（ROOT NAME SERVER）**
全球共有13台。名称分别从“A”至“M”。
根域名服务器是架构因特网所必须的基础设施，主要用来管理互联网的主目录。1个为主根服务器，放置在美国。其余12个均为辅根服务器，其中9个放置在美国，欧洲2个，位于英国和瑞典，亚洲1个，位于日本。所有根服务器均由美国政府授权的互联网域名与号码分配机构ICANN统一管理，负责全球互联网域名根服务器、域名体系和IP地址等的管理。
   - 主要作用:
在根域名服务器中储存了负责每个域（如COM、NET、ORG等）的解析的域名服务器的地址信息，互联网访问者本地DNS服务器进行域名解析时若本地无结果，则转问根域名服务器。由根域名服务器进行顶级域名解析并指定下一个域名服务器进行下一步解析。

![](http://i.imgur.com/9vTgJDT.jpg)[15]


![](http://i.imgur.com/iiXHb3f.png)



###查询方式

 - **递归查询**：一般指客户机和服务器之间的查询方式，当客户机向DNS服务器发出请求后,若- DNS服务器本身不能解析,则会向另外的DNS服务器发出查询请求，得到结果后转交给客户机
 - **迭代查询**：一般指DNS服务器之间的查询方式，若DNS2不能响应DNS1的请求，则它会将DNS3的IP发送给DNS1，以便其再向DNS3发出请求；

![](http://i.imgur.com/tF2qhIs.jpg)


# 5.域名协议 #


----------
[10] [12] [14]
###封装协议
- DNS同时占用UDP和TCP端口53，在实际传输时，使用TCP协议进行区域传输，使用UDP协议进行客户端与DNS服务器之间通信。
  - 区域传输：DNS的规范规定了两种类型的DNS服务器：主DNS服务器和辅助DNS服务器。在一个区中主DNS服务器从自己本机的数据文件中读取该区的DNS数据信息，而辅助DNS服务器则从区的主DNS服务器中读取该区的DNS数据信息。当一个辅助DNS服务器启动时，它需要与主DNS服务器通信，并加载数据信息，这就叫做区域传送（zone transfer）。

###DNS协议

![](http://i.imgur.com/t7Vgw8T.jpg)

- 正文部分中，回答、授权和额外信息部分只出现在DNS应答报文中
- 首部各字段分析：

####首部字段分析####
  - 标识（2字节）：可以看作是DNS报文的ID，对于相关联的请求报文和应答报文，这个字段是相同的，由此可以区分DNS应答报文是哪个请求报文的响应。
  - 标志（2字节）：需要逐比特分析，如下：
  
   
![](http://i.imgur.com/gRMWv1I.png)


      - QR(1比特）：查询/响应的标志位，1为响应，0为查询。
      - opcode（4比特）：定义查询或响应的类型（若为0则表示是标准的，若为1则是反向的，若为2则是服务器状态请求）。
      - AA（1比特）：授权回答的标志位。该位在响应报文中有效，1表示名字服务器是权限服务器
      - TC（1比特）：截断标志位。1表示响应已超过512字节并已被截断（与UDP协议有关）
      - RD（1比特）：该位为1表示客户端希望得到递归回答
      - RA（1比特）：只能在响应报文中置为1，表示可以得到递归响应
      - zero（3比特）：保留字段
      - rcode（4比特）：返回码，表示响应的差错状态，通常为0和3，各取值含义如下：
          - 0          无差错
          - 1          格式差错
          - 2          问题在域名服务器上
          - 3          域参照问题
          - 4          查询类型不支持
          - 5          在管理上被禁止
          - 6~15  	   保留


- 问题数、资源记录数、授权资源记录数和额外资源记录数，这四个字段都是两字节，分别对应查询问题、回答、授权和额外信息部分的数量。一般问题数都为1。DNS查询报文中，资源记录数、授权资源记录数和额外资源记录数都为0.


####正文部分

![](http://i.imgur.com/vQ3DVB4.png)

- **查询问题**部分格式如下：
  - 查询名（长度不定）：一般为要查询的域名（或IP，即反向查询）。此部分由一个或者多个标示符序列组成，每个标示符以首字节数的计数值来说明该标示符长度，每个名字以0结束。计数字节数必须是0~63之间。该字段无需填充字节。例如，查询名为gemini.tuc.noao.edu时，查询名字段如下：
 ![](http://i.imgur.com/Djbyher.png)
 - 查询类（2字节）：通常为1，指Internet数据。

  - 查询类型（2字节）：通常查询类型为A（由域名获得IP地址）或者PTR（获得IP地址对应的域名），类型列表如下：

   类型----------助记符------说明

    
    - 1      		A 	   	IPv4地址。
    - 2 	       	NS 		名字服务器。
    - 5 	      	CNAME 	规范名称。定义主机的正式名字的别名。
    - 6 	      	SOA   	开始授权。标记一个区的开始。
    - 11 	   	WKS   	熟知服务。定义主机提供的网络服务。
    - 12 	   	PTR 	   指针。把IP地址转化为域名。
    - 13 	   	HINFO 	主机信息。给出主机使用的硬件和操作系统的表述。
    - 15 	   	MX 		邮件交换。把邮件改变路由送到邮件服务器。
    - 28 	   	AAAA 	   IPv6地址。
    - 252 	   	AXFR   	传送整个区的请求。
    - 255 	   	ANY    	对所有记录的请求。

- **回答字段**，**授权字段** 和 **额外信息**字段均采用资源记录RR（Resource Record）的相同格式。该格式如下：

![](http://i.imgur.com/sVAMAkC.png)


   - 域名字段（不定长或2字节）：记录中资源数据对应的名字，它的格式和查询名字段格式相同。当报文中域名重复出现时，就需要使用2字节的偏移指针来替换。例如，在资源记录中，域名通常是查询问题部分的域名的重复，就需要用指针指向查询问题部分的域名。指针的用法为：总长度2字节，最高两位是11，用于识别指针。其他14位从报文开始处计数（从0开始），指出该报文中的相应字节数。DNS报文的第一个字节是字节0，第二个报文是字节1。一般响应报文中，资源部分的域名都是指针C00C(1100000000001100)，刚好指向请求部分的域名。
   - 类型（2字节）、类（2字节）：含义与查询问题部分的类型和类相同。
   - 生存时间（4字节）：该字段表示资源记录的生命周期（以秒为单位），一般用于当地址解析程序取出资源记录后决定保存及使用缓存数据的时间。
   - 资源数据长度（2字节）：表示资源数据的长度（以字节为单位，如果资源数据为IP则为0004）
   - 资源数据：该字段是可变长字段，表示按查询段要求返回的相关资源记录的数据。




# 6.域名注册流程 #
[8]

注册人提交域名注册申请->注册商建立WHOIS记录并向域名注册局提交数据

以下图表则解释了这一过程中相关方的主要职能。
![](http://i.imgur.com/iJiZ6Xq.gif)

- **注册人**  注册域名的个人或组织。
注册人在注册域名时向域名注册商或其分销商提交注册申请并将其域名放在域名服务器上，使得该域名能够在互联网上得到访问。


- **注册商** ICANN授权的组织，并得到注册局运营商认证可以销售域名的单位，主要处理域名注册销售的日常事务。注册商的职责包括：维护WHOIS数据、向域名注册局提交数据、支持公共WHOIS查询服务、确保注册人的详细信息由第三方托管、遵守RAA中与注册期结束相关的条件。注册商在收到域名注册申请后将检查该域名是否可用，并按照注册人提供的信息建立一个WHOIS记录。

- **分销商**  注册商下属的或与注册商签订了合同的机构，同样可以完成域名注册，它们通常还提供其他服务，例如：网络托管、电子邮箱服务等等。

- **注册局运营商**  负责维护每个顶级域名的注册和查询。注册局运营商的责任包括：接受注册请求；维护必要的注册数据库；提供域名服务器以在互联网上发布网域档案数据（顶级域名查询时的位置信息）。

- **注册局** 在每个顶级域名下注册的域名的权威主数据库。注册局运营商维护该主数据库，并生成“区域文件”，使得计算机能够在全世界的任何角落登入或登出顶级域名。互联网用户不与注册局运营商直接接触；用户通过使用一家ICANN授权的注册商，在顶级域名项下能够注册的域名包括：.biz、.com、.info、.net、.name、.org。

- **互联网名称与数字地址分配机构**  （ICANN） 非营利性的国际型企业，旨在监督IP地址和域名的分配。负责管理根服务器和顶级域名系统管理，并分别于注册局和注册商签署协议，为WHOIS系统奠定基础。






##参考文献和资料

[1] RFC1034--《域名-概念和设施》

[2] RFC1035--《域名-实现及标准》

[3] RFC1591--《域名-结构和授权》

[4] [《蓝学网-域名解析全过程分析图》](http://www.ablanxue.com/prone_10799_1.html)

[5] [《博客-Windows网络服务dns》](http://blog.sina.com.cn/s/blog_ce9cfbc40102v0bv.html)

[6] [《233网校-全国计算机等级考试三级网络技术第19讲》](http://wx.233.com/search/school/Courseaware/downtext.asp?id=6850) 

[7] [《域名解析的算法流程》](http://host.zzidc.com/yumingjiexi/13.html)

[8] [《ICANN官方WHOIS服务器主页》](https://whois.icann.org/zh)

[9] [《IANA官方国际顶级域名统计》](https://newgtlds.icann.org/en/program-status/statistics)

[10] 百度文库--《DNS协议原理》

[11] 百度文库--《DNS协议详解》

[12] 中国知网-罗海峰著--《基于DNS协议分析的流量监测系统》

[13] 人民邮电出版社-Cricket Liu,Paul Albitz著--《DNS与BIND》

[14] 百度文库--《域名的概念与机制》

[15] [《江苏经济报-美国为何把持全球互联网“总开关”》](http://jsjjb.xhby.net/html/2014-06/06/content_1038975.htm)

[16] 华东理工大学计算机学院-《域名详解主机名IP地址物理地址》 

[17] [站长网-域名知识导航](http://www.admin5.com/special/yumingzs/)